---
title: "METARET -- a Meta Analysis of the External Validity of Risk Elicitation Tasks"
author: "Paolo Crosetto"
date: "This version: June 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

This project is about the **external validity** of **risk elicitation tasks** (RETs) -- i.e. their ability to predict self-reported or real-world behavior.

This repository contains 

- **data** contributed from each of several *contributed papers* by experimental economists and social psychologists. 
- **code** to format each original dataset into a common format for later analysis
- **results** in the form of plots and tables (*work in progress*)
- **code** for an interactive shiny app that will give the users the possibility to explore the data by themselves (*completely TODO*)

### Contributed papers (list updates as papers are contributed)

- Crosetto, Paolo, and Filippin, Antonio, *The Bomb Risk Elicitation Task*, JRU, 2013 [paper](https://link.springer.com/article/10.1007/s11166-013-9170-z) [data](/Data/Crosetto_Filippin_Experimental_Economics_2016)
- Crosetto, Paolo, and Filippin, Antonio, *A Theoretical and Experimental Appraisal of Four Risk ELicitation Methods*, ExEc, 2016 [paper](https://link.springer.com/article/10.1007/s10683-015-9457-9) [data](/Data/Crosetto_Filippin_Journal_Risk_Uncertainty_2013/)

## First look at the results

As a first step, I compute the (Pearson) correlation of each RET to (each of a series of) self-reported risk measures.

Each task is represented by a point estimate + confidence interval. Here are the results of correlations between several tasks and:

- the SOEP risk question 
- the DOSPERT scale and its subscales

The plots and analyses are updated for each new contributed paper.

```{r, fig.height=12, fig.width = 9, dpi=600}

### playing around with the correlation plots
library(tidyverse)
library(broom)
library(hrbrthemes)

theme_set(theme_ipsum_rc()+
            theme(legend.position = "bottom")+
            theme(strip.text.x = element_text(hjust = 0.5))+
            theme(panel.spacing.x = unit(0.2, "lines")))

## getting data from all the "formatted_dataset.csv" files in each subdirectory of /Data
df <- list.files(recursive = T, pattern = "^formatted_dataset") %>% 
  map_dfr(read_csv)

#### playground for the final plot -- commented away

## TODO/ need to automate this in a function, adn don't know how. MESSY!

# SOEP
soep <- df %>%
  nest(-paper, -task, -treatment) %>%
  mutate(
    test = map(data, ~ cor.test(.x$choice, .x$soep, method = "pearson", conf.level = 0.95)), 
    tidied = map(test, tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>% 
    mutate(questionnaire = "SOEP")

# DOSPERT
dospert <- df %>%
  nest(-paper, -task, -treatment) %>%
  mutate(
    test = map(data, ~ cor.test(.x$choice, .x$doall, method = "pearson", conf.level = 0.95)), 
    tidied = map(test, tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>% 
    mutate(questionnaire = "DOSPERT")

# DOSPERT-GAMBLE
dogamble <- df %>%
  nest(-paper, -task, -treatment) %>%
  mutate(
    test = map(data, ~ cor.test(.x$choice, .x$dogamble, method = "pearson", conf.level = 0.95)), 
    tidied = map(test, tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>% 
    mutate(questionnaire = "D-gamble")

# DOSPERT-INVESTMENT
doinvest <- df %>%
  nest(-paper, -task, -treatment) %>%
  mutate(
    test = map(data, ~ cor.test(.x$choice, .x$doinvest, method = "pearson", conf.level = 0.95)), 
    tidied = map(test, tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>% 
    mutate(questionnaire = "D-invest")

# DOSPERT-HEALTH
dohealth <- df %>%
  nest(-paper, -task, -treatment) %>%
  mutate(
    test = map(data, ~ cor.test(.x$choice, .x$dohealth, method = "pearson", conf.level = 0.95)), 
    tidied = map(test, tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>% 
    mutate(questionnaire = "D-health")

# rbind
corr <- rbind(soep, dospert, dogamble, doinvest, dohealth) %>% 
  mutate(questionnaire = fct_relevel(as_factor(questionnaire), "SOEP", "DOSPERT"))

# join  the N of observations oer study
corr <- df %>% group_by(paper, task, treatment) %>% summarise(N = n()) %>% left_join(corr, by = c("paper", "task", "treatment"))

# another stupid hack
corr <- corr %>% mutate(treatment = if_else(is.na(treatment), "", treatment))

## plot on non-transformed values
corr %>%
  filter(treatment != "repeated") %>%
  mutate(p.value = cut(p.value,
                       breaks = c(-1, 0.01, 0.05, 0.1, 1),
                       labels = c("<1%", "<5%", "<10%", "n.s."))) %>%
  mutate(treatment = paste(treatment, " (N = ", N, ")", sep ="")) %>%
  ggplot(aes(reorder(treatment, estimate), estimate, color= p.value))+
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high), width = 0.2)+
   geom_point(size = 2)+
   coord_flip()+
   geom_hline(yintercept = 0, linetype = "dotted", color = "indianred")+
   scale_color_manual(name = "significance", values = c("red", "orange", "yellow", "black"), drop = F)+
  scale_y_continuous(breaks = c(-0.2, 0, 0.2, 0.4), labels = c("-0.2","0","0.2","0.4"))+
   facet_grid(task~questionnaire, scales = "free_y", space = "free_y")+
   xlab("")+ylab("Pearson correlation")

```

